name: AI-Powered Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]

jobs:
  # AI Code Analysis and Review
  ai-code-review:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: AI Code Review Analysis
      run: |
        echo "ðŸ¤– AI Analyzing code changes for review..."
        node scripts/ai-code-review.js

    - name: AI Performance Impact Analysis
      run: |
        echo "ðŸ¤– AI Analyzing performance impact..."
        node scripts/performance-analysis.js

    - name: AI Security Vulnerability Check
      run: |
        echo "ðŸ¤– AI Checking for security vulnerabilities..."
        node scripts/security-vulnerability-check.js

    - name: AI Code Style and Best Practices Review
      run: |
        echo "ðŸ¤– AI Reviewing code style and best practices..."
        node scripts/code-style-review.js

    - name: Generate AI Review Comments
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const reviewData = JSON.parse(fs.readFileSync('ai-review-results.json', 'utf8'));
          
          // Create review comment
          const comment = `## ðŸ¤– AI Code Review Results
          
          ### ðŸ“Š Overall Score: ${reviewData.score}/100
          
          ### ðŸ” Issues Found:
          ${reviewData.issues.map(issue => `- **${issue.severity}**: ${issue.message} (${issue.file}:${issue.line})`).join('\n')}
          
          ### ðŸ’¡ Suggestions:
          ${reviewData.suggestions.map(suggestion => `- ${suggestion}`).join('\n')}
          
          ### âœ… Positive Aspects:
          ${reviewData.positives.map(positive => `- ${positive}`).join('\n')}
          
          ---
          *Generated by AI SDLC Framework*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # AI Automated Testing for PRs
  ai-pr-testing:
    runs-on: ubuntu-latest
    needs: ai-code-review
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate PR-Specific Tests
      run: |
        echo "ðŸ¤– AI Generating tests for PR changes..."
        node scripts/generate-pr-tests.js

    - name: Run PR Tests
      run: npm test

    - name: AI Test Result Analysis
      run: |
        echo "ðŸ¤– AI Analyzing test results..."
        node scripts/analyze-test-results.js

  # AI Dependency Analysis
  ai-dependency-review:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate

    - name: AI Dependency Security Analysis
      run: |
        echo "ðŸ¤– AI Analyzing dependency security..."
        npm audit --json > dependency-audit.json
        node scripts/dependency-security-analysis.js

    - name: AI License Compatibility Check
      run: |
        echo "ðŸ¤– AI Checking license compatibility..."
        node scripts/license-compatibility-check.js

  # AI Merge Readiness Check
  ai-merge-readiness:
    runs-on: ubuntu-latest
    needs: [ai-code-review, ai-pr-testing, ai-dependency-review]
    if: github.event_name == 'pull_request'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: AI Merge Readiness Assessment
      run: |
        echo "ðŸ¤– AI Assessing merge readiness..."
        node scripts/merge-readiness-assessment.js

    - name: Update PR Status with AI Recommendation
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const readinessData = JSON.parse(fs.readFileSync('merge-readiness-results.json', 'utf8'));
          
          const status = readinessData.ready ? 'success' : 'failure';
          const description = readinessData.ready ? 
            'âœ… AI recommends merge - All checks passed' : 
            `âŒ AI recommends against merge - ${readinessData.blockers.length} blockers found`;
          
          github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.sha,
            state: status,
            target_url: 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}',
            description: description,
            context: 'AI Merge Readiness'
          });

  # AI Documentation Update Check
  ai-docs-update-check:
    runs-on: ubuntu-latest
    needs: ai-code-review
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: AI Documentation Analysis
      run: |
        echo "ðŸ¤– AI Checking if documentation needs updates..."
        node scripts/docs-update-check.js

    - name: Suggest Documentation Updates
      uses: actions/github-script@v6
      if: failure()
      with:
        script: |
          const fs = require('fs');
          const docsData = JSON.parse(fs.readFileSync('docs-check-results.json', 'utf8'));
          
          const comment = `## ðŸ“š AI Documentation Suggestions
          
          The following documentation updates are recommended:
          
          ${docsData.suggestions.map(suggestion => `- ${suggestion}`).join('\n')}
          
          ### Files to Update:
          ${docsData.files.map(file => `- \`${file}\``).join('\n')}
          
          ---
          *Generated by AI SDLC Framework*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
